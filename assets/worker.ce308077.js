(function(){"use strict";function X({width:e}){return function(r,n){return(n*e+r)*4}}const U=(e,t,r,n,o)=>{const i=X(e),a=X(t),s=t.width*t.height;let c=0,l=0,P=0,p=0,u=0;for(let F=0,ot=t.height;F<ot;F++)for(let R=0,st=t.width;R<st;R++){const A=o(e,i(r+R,n+F)),I=o(t,a(R,F));c+=A**2,l+=A,P+=I**2,p+=I,u+=A*I}const f=l/s,M=p/s,j=u/s,v=c/s,m=P/s,y=j-f*M,_=v-f**2,nt=m-M**2;return y/(Math.sqrt(_)*Math.sqrt(nt))},k=(e,t)=>e.data[t]*.3+e.data[t+1]*.59+e.data[t+2]*.11;function*q(e,t,r,n){for(let o=r;o<n;++o)for(let i=e;i<t;++i)yield{pos:{x:i,y:o},meta:{}}}function*Y(e,t){yield*q(t.offsetX,e.width-t.originW+t.offsetX,t.offsetY,e.height-t.originH+t.offsetY)}function B(e){const t=e.at(-1);if(t===void 0)throw new Error("something wrong: peekLast takes zero scores");return t}var W=function(e,t,r,n,o){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?o.call(e,r):o?o.value=r:t.set(e,r),r},C=function(e,t,r,n){if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?n:r==="a"?n.call(e):n?n.value:t.get(e)},g,E,T;class H{constructor(t=B){g.set(this,null),E.set(this,-1/0),T.set(this,void 0),W(this,T,t,"f")}retrieve(t,r){var n,o;const i=C(this,T,"f").call(this,((n=t.meta.scores)!==null&&n!==void 0?n:[]).concat(r));if(i>C(this,E,"f")){const a=structuredClone(t),s=(o=a.meta.scores)!==null&&o!==void 0?o:[];s.push(i),a.meta.scores=s,W(this,E,i,"f"),W(this,g,a,"f")}}first(){if(C(this,g,"f")===null)throw new Error("something wrong: result is null");return structuredClone(C(this,g,"f"))}all(){return[this.first()]}}g=new WeakMap,E=new WeakMap,T=new WeakMap;function G(e,t,r,n,o,i){const a=i();for(const s of o()){const c=r(e,t,s.pos.x,s.pos.y,n);a.retrieve(s,c)}return a}function V(e,t,r,n,o,i){return G(e,t,n,o,()=>Y(e,r),i)}var L=function(e,t,r,n,o){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?o.call(e,r):o?o.value=r:t.set(e,r),r},b=function(e,t,r,n){if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?n:r==="a"?n.call(e):n?n.value:t.get(e)},O,x,S;class J{constructor(t,r){O.set(this,void 0),x.set(this,[]),S.set(this,void 0),L(this,S,t,"f"),L(this,O,r,"f")}retrieve(t,r){var n,o;const i=b(this,S,"f").call(this,((n=t.meta.scores)!==null&&n!==void 0?n:[]).concat(r));if(i>b(this,O,"f")){const a=structuredClone(t),s=(o=a.meta.scores)!==null&&o!==void 0?o:[];s.push(i),a.meta.scores=s,b(this,x,"f").push(a)}}first(){const t=b(this,x,"f")[0];if(!t)throw new Error("something wrong: result is empty");return t}all(){return b(this,x,"f").slice()}}O=new WeakMap,x=new WeakMap,S=new WeakMap;function K(e,t){const r=e.width,n=e.height,o=Math.ceil(r/t),i=Math.ceil(n/t);let a=[];for(let s=0;s<o;s++)for(let c=0;c<i;c++){const l=n%t>0&&c===i-1,P=r%t>0&&s===o-1,p=l?n%t:t,u=P?r%t:t,f=new Uint8ClampedArray(p*u*4),M=c*t,j=s*t;for(let v=0;v<p;++v)for(let m=0;m<u;++m){const y=(v*u+m)*4,_=((M+v)*r+(j+m))*4;f[y]=e.data[_],f[y+1]=e.data[_+1],f[y+2]=e.data[_+2],f[y+3]=e.data[_+3]}a.push({data:new ImageData(f,u,p),offsetX:j,offsetY:M,originH:n,originW:r})}return a}function*N(e,t){for(const r of t)yield Object.assign(Object.assign({},r),{pos:{x:r.pos.x+e.x,y:r.pos.y+e.y}})}var $=function(e,t,r,n,o){if(n==="m")throw new TypeError("Private method is not writable");if(n==="a"&&!o)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return n==="a"?o.call(e,r):o?o.value=r:t.set(e,r),r},d=function(e,t,r,n){if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return r==="m"?n:r==="a"?n.call(e):n?n.value:t.get(e)},w,h;class Q{constructor(t,r){w.set(this,void 0),h.set(this,void 0),$(this,h,t,"f"),$(this,w,r,"f")}retrieve(t,r){return d(this,w,"f").retrieve(t,r)}first(){const t=d(this,w,"f").first();if(!t)throw new Error("something wrong: result is empty");return Object.assign(Object.assign({},t),{pos:{x:t.pos.x-d(this,h,"f").x,y:t.pos.y-d(this,h,"f").y}})}all(){return d(this,w,"f").all().map(t=>Object.assign(Object.assign({},t),{pos:{x:t.pos.x-d(this,h,"f").x,y:t.pos.y-d(this,h,"f").y}}))}}w=new WeakMap,h=new WeakMap;function Z(e){if(e.length===0)return 0;let t=0;for(const r of e)t+=r;return t/e.length}function D(e,t){return e.score<t.score?1:t.score<e.score?-1:0}function z(e,t,r=1){var n,o,i;let a=[];for(const s of e){const c=t((n=s.meta.scores)!==null&&n!==void 0?n:[]),l=(i=(o=a.at(-1))===null||o===void 0?void 0:o.score)!==null&&i!==void 0?i:-1/0;c>l&&a.push({candidate:s,score:c}),a.sort(D),a=a.slice(0,r)}return a.map(s=>s.candidate)}const tt=(e,t)=>{const r=z(e,t,1)[0];if(!r)throw new Error("something wrong");return r};function et(e){return Math.max(...e)}function rt(e,t,r,n,o=.6,i=a=>K(a,24)){const a=i(t);if(a.length===1)return V(e,a[0].data,a[0],r,n,()=>new H).first().pos;let s=[];for(const c of a){const l={x:c.offsetX,y:c.offsetY};if(s=G(e,c.data,r,n,()=>N(l,c===a[0]?Y(e,c):s),()=>new Q(l,new J(Z,o))).all(),s.length===1&&s[0])return s[0].pos}return tt(s,et).pos}onmessage=e=>{const{base:t,temp:r}=e.data,n=rt(new ImageData(new Uint8ClampedArray(t.data),t.width,t.height),new ImageData(new Uint8ClampedArray(r.data),r.width,r.height),U,k,.95);postMessage(n)}})();

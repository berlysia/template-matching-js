(function(){"use strict";function M({width:e}){return function(o,r){return(r*e+o)*4}}const $=(e,t,o,r,n)=>{const i=M(e),s=M(t),a=t.width*t.height;let c=0,h=0,l=0,v=0,S=0;for(let b=0,Q=t.height;b<Q;b++)for(let _=0,Z=t.width;_<Z;_++){const P=n(e,i(o+_,r+b)),T=n(t,s(_,b));c+=P**2,h+=P,l+=T**2,v+=T,S+=P*T}const F=h/a,C=v/a,L=S/a,U=c/a,V=l/a,z=L-F*C,J=U-F**2,K=V-C**2,O=Math.sqrt(J)*Math.sqrt(K);return O===0?1:z/O},A=(e,t)=>e.data[t]*.3+e.data[t+1]*.59+e.data[t+2]*.11;function*R(e,t,o,r){for(let n=o;n<r;++n)for(let i=e;i<t;++i)yield{pos:{x:i,y:n},meta:{}}}function*W(e,t){yield*R(t.offsetX,e.width+-t.originW,t.offsetY,e.height+-t.originH)}function X(e,t,o,r,n,i){const s=i();for(const a of n()){const c=o(e,t,a.pos.x,a.pos.y,r);s.retrieve(a,c)}return s}var E=function(e,t,o,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,o):n?n.value=o:t.set(e,o),o},d=function(e,t,o,r){if(o==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?r:o==="a"?r.call(e):r?r.value:t.get(e)},g,p,m;class Y{constructor(t,o){g.set(this,void 0),p.set(this,[]),m.set(this,void 0),E(this,m,t,"f"),E(this,g,o,"f")}retrieve(t,o){var r,n;const i=d(this,m,"f").call(this,((r=t.meta.scores)!==null&&r!==void 0?r:[]).concat(o));if(i>d(this,g,"f")){const s=structuredClone(t),a=(n=s.meta.scores)!==null&&n!==void 0?n:[];a.push(i),s.meta.scores=a,d(this,p,"f").push(s)}}first(){const t=d(this,p,"f")[0];if(!t)throw new Error("something wrong: result is empty");return t}all(){return d(this,p,"f").slice()}}g=new WeakMap,p=new WeakMap,m=new WeakMap;function*j(e,t){for(const o of t){const r=o.pos.x+e.x,n=o.pos.y+e.y;yield Object.assign(Object.assign({},o),{pos:{x:r,y:n}})}}var x=function(e,t,o,r,n){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!n)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?n.call(e,o):n?n.value=o:t.set(e,o),o},f=function(e,t,o,r){if(o==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return o==="m"?r:o==="a"?r.call(e):r?r.value:t.get(e)},u,w;class N{constructor(t,o){u.set(this,void 0),w.set(this,void 0),x(this,w,t,"f"),x(this,u,o,"f")}retrieve(t,o){return f(this,u,"f").retrieve(t,o)}first(){const t=f(this,u,"f").first();if(!t)throw new Error("something wrong: result is empty");return Object.assign(Object.assign({},t),{pos:{x:t.pos.x-f(this,w,"f").x,y:t.pos.y-f(this,w,"f").y}})}all(){return f(this,u,"f").all().map(t=>Object.assign(Object.assign({},t),{pos:{x:t.pos.x-f(this,w,"f").x,y:t.pos.y-f(this,w,"f").y}}))}}u=new WeakMap,w=new WeakMap;function G(e){if(e.length===0)return 0;let t=0,o=!1;for(const r of e)Number.isFinite(r)?t+=r:o=!0;return o&&console.error(`average takes some non-finite value: ${e.join(", ")}`),t/e.length}function I(e,t,o,r,n,i,s){const a=i(t);let c=[];for(const h of a){const l={x:h.offsetX,y:h.offsetY};if(c=X(e,h.data,o,r,()=>h===a[0]?j(l,W(e,h)):j(l,c),()=>new N(l,new Y(G,n))).all(),s==null||s(c),c.length===1&&c[0])return c}return c}function D(e,t){if(t*4>e.length)throw new Error(`out of bounds - current: ${t*4}...${t*4+3}, length: ${e.length}`);return{r:e[t*4],g:e[t*4+1],b:e[t*4+2],a:e[t*4+3]}}function B(e,t,o){var r;if(t*4>e.length)throw new Error(`out of bounds - current: ${t*4}...${t*4+3}, length: ${e.length}`);e[t*4]=o.r,e[t*4+1]=o.g,e[t*4+2]=o.b,e[t*4+3]=(r=o.a)!==null&&r!==void 0?r:255}function y(e,t,o){return e<=t?t:e>=o?o-1:e}function q(e,t,o,r,n){const i=Math.abs(Math.min(o-n,0)),s=Math.abs(Math.min(r-n,0)),a=Math.max(o+n-e,0),c=Math.max(r+n-t,0);return{x:Math.max(o-n,0),y:Math.max(r-n,0),w:n*2+1-i-a,h:n*2+1-s-c,overflowNegativeX:i,overflowPositiveX:a,overflowNegativeY:s,overflowPositiveY:c}}function H(e,t){const o=[];for(const{x:r,y:n,radius:i}of t){const s=q(e.width,e.height,r,n,i),a=new ImageData(s.w,s.h);for(let c=-i;c<=i-s.overflowPositiveY;++c)for(let h=-i;h<=i-s.overflowPositiveX;++h){const l=y(c+i-s.overflowNegativeY,0,s.h)*s.w+y(h+i-s.overflowNegativeX,0,s.w),v=y(n+c,0,e.height)*e.width+y(r+h,0,e.width);B(a.data,l,D(e.data,v))}o.push({data:a,offsetX:s.x,offsetY:s.y,originH:e.height,originW:e.width})}return o}onmessage=e=>{const{base:t,temp:o,features:r}=e.data,n=new ImageData(new Uint8ClampedArray(o.data),o.width,o.height),i=I(new ImageData(new Uint8ClampedArray(t.data),t.width,t.height),n,$,A,.7,s=>H(s,r));postMessage(i)}})();
